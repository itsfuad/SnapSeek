<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Search Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .image-card {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 0.5rem;
            transition: transform 0.2s;
        }
        .image-card:hover {
            transform: scale(1.05);
        }
        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .similarity-score {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .progress {
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- Status Display -->
    <div class="card status-card" id="statusCard" data-initial-status='{{ initial_status | tojson | safe }}'>
        <div class="card-header">
            <h5 class="card-title mb-0">Indexing Status</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <strong>Status:</strong> <span id="statusText" class="badge bg-secondary">idle</span>
            </div>
            <div class="mb-3">
                <strong>Progress:</strong>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
                <small class="text-muted">0 / 0 files</small>
            </div>
            <div class="mb-3">
                <strong>Current File:</strong>
                <div id="currentFile" class="text-truncate">None</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-5">
        <h1>Image Search Engine</h1>
        
        <!-- Search Forms -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Text Search</h5>
                    </div>
                    <div class="card-body">
                        <form id="textSearchForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="textQuery" placeholder="Enter search query">
                            </div>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>
                        <div id="textSearchResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Image Search</h5>
                    </div>
                    <div class="card-body">
                        <form id="imageSearchForm">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="imageFile" accept="image/*">
                            </div>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>
                        <div id="imageSearchResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize with server-provided status
        const statusCard = document.getElementById('statusCard');
        const initialStatus = JSON.parse(statusCard.dataset.initialStatus);
        updateStatusDisplay(initialStatus);

        // WebSocket connection for status updates
        const ws = new WebSocket(`ws://${window.location.host}/ws/status`);
        
        ws.onmessage = function(event) {
            const status = JSON.parse(event.data);
            updateStatusDisplay(status);
        };
        
        ws.onclose = function() {
            console.log('WebSocket connection closed');
        };
        
        function updateStatusDisplay(status) {
            document.getElementById('statusText').textContent = status.status;
            document.getElementById('statusText').className = `badge bg-${getStatusColor(status.status)}`;
            
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${status.progress_percentage}%`;
            progressBar.textContent = `${status.progress_percentage}%`;
            
            document.querySelector('.text-muted').textContent = 
                `${status.processed_files} / ${status.total_files} files`;
            
            document.getElementById('currentFile').textContent = status.current_file || 'None';
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'idle': return 'secondary';
                case 'indexing': return 'primary';
                case 'monitoring': return 'success';
                default: return 'secondary';
            }
        }
        
        // Search form handlers
        document.getElementById('textSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('textQuery').value;
            const response = await fetch(`/search/text?query=${encodeURIComponent(query)}`);
            const results = await response.json();
            displayResults(results, 'textSearchResults');
        });
        
        document.getElementById('imageSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('imageFile').files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/search/image', {
                method: 'POST',
                body: formData
            });
            const results = await response.json();
            displayResults(results, 'imageSearchResults');
        });
        
        function displayResults(results, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = results.map(result => `
                <div class="card mb-2">
                    <img src="${result.path}" class="card-img-top" alt="Search result">
                    <div class="card-body">
                        <p class="card-text">Path: ${result.path}</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html> 